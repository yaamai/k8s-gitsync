test_operator_get_state:
- desc: normal
  in: {"metadata": {"name": "a", "namespace": "b"}, "kind": "Pod"}
  expect: ['kubectl', '-n', 'b', 'get', 'Pod', 'a', '-o', 'json']
- desc: missing namespace
  in: {"metadata": {"name": "a"}, "kind": "Pod"}
  expect: ['kubectl', '-n', 'default', 'get', 'Pod', 'a', '-o', 'json']
- desc: missing name
  in: {"metadata": {}, "kind": "Pod"}
  expect: []
  raise: True
  return:
    msg: "invalid manifest"

test_operator_get_state_helm:
- desc: normal
  cmd_exec:
  - [!bytes "{}", !bytes "{}", 0]
  in:
    name: hoge
    namespace: hoge
    chart:
      name: hoge
      version: 1.0.0
      repo: https://hoge.internal
    values:
      a: 100
  expect:
  - args: [['helm', '-n', 'hoge', 'get', 'values', 'hoge', '--output', 'json']]
    kwargs: {}
- desc: state not found
  cmd_exec:
    - [!bytes "{}", !bytes "Error: release: not found", 1]
  in:
    name: hoge
    namespace: hoge
    chart:
      name: hoge
      version: 1.0.0
      repo: https://hoge.internal
    values:
      a: 100
  expect:
  - args: [['helm', '-n', 'hoge', 'get', 'values', 'hoge', '--output', 'json']]
    kwargs: {}
  return:
    result: null
    detail: {msg: "notfound"}
    #- desc: missing namespace
    #  cmd_exec:
    #  - [!bytes "{}", !bytes "{}", 0]
    #  in: {"metadata": {"name": "a"}, "kind": "Pod"}
    #  expect: ['kubectl', '-n', 'default', 'get', 'Pod', 'a', '-o', 'json']
    #- desc: missing name
    #  cmd_exec:
    #  - [!bytes "{}", !bytes "{}", 0]
    #  in: {"metadata": {}, "kind": "Pod"}
    #  expect: []
    #  return:
    #    msg: "invalid manifest"

test_operator_create_or_update:
- desc: normal state does not synced
  cmd_exec:
  - [!bytes "{}", !bytes "{}", 0]
  - [!bytes "{}", !bytes "{}", 0]
  - [!bytes "{}", !bytes "{}", 0]
  in: {"metadata": {"name": "a", "namespace": "b"}, "kind": "Pod"}
  expect:
  - args: [['kubectl', '-n', 'b', 'get', 'Pod', 'a', '-o', 'json']]
    kwargs: {}
  - args: [['kubectl', 'create', 'namespace', 'b']]
    kwargs: {}
  - args: [['kubectl', 'apply', '-f', '-']]
    kwargs:
      stdin: !bytes |
        kind: Pod
        metadata:
          annotations:
            k8s-gitsync/last-applied-confighash: eedf1596e62bc950fd41873f337e58dea4a665c0025e1041ea5ff508b6ec14b9
          labels:
            k8s-gitsync/managed: 'true'
          name: a
          namespace: b
- desc: normal state synced
  cmd_exec:
  - - !bytes |
      {
        "metadata": {
          "annotations": {
            "k8s-gitsync/last-applied-confighash": "eedf1596e62bc950fd41873f337e58dea4a665c0025e1041ea5ff508b6ec14b9"
          }
        }
      }
    - !bytes "{}"
    - 0
  in: {"metadata": {"name": "a", "namespace": "b"}, "kind": "Pod"}
  expect:
  - args: [['kubectl', '-n', 'b', 'get', 'Pod', 'a', '-o', 'json']]
    kwargs: {}
